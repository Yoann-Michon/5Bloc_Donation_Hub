// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Ethereum addresses
model User {
  address           String     @id
  tokenCount        Int        @default(0)
  totalDonated      String     @default("0") // BigInt as string (Wei)
  lastTransactionAt DateTime?
  lockEndTime       DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  tokens            Token[]
  donations         Donation[]
  projects          Project[]

  @@index([totalDonated])
  @@map("users")
}

// Project model - Crowdfunding projects
model Project {
  id              Int        @id @default(autoincrement())
  onChainId       Int        @unique
  creator         String
  metadataURI     String
  fundingGoal     String     // BigInt as string (Wei)
  totalRaised     String     @default("0") // BigInt as string (Wei)
  deadline        DateTime
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  closedAt        DateTime?

  creatorUser     User       @relation(fields: [creator], references: [address])
  donations       Donation[]

  @@index([isActive, deadline])
  @@index([creator])
  @@map("projects")
}

// Token model - NFT badges
model Token {
  id              Int        @id @default(autoincrement())
  tokenId         Int        @unique
  owner           String
  level           Int        // 0=DONOR, 1=SPONSOR, 2=PATRON, 3=BENEFACTOR
  donationAmount  String     // BigInt as string (Wei)
  metadataURI     String
  mintedAt        DateTime
  lastTransferAt  DateTime
  isBurned        Boolean    @default(false)
  
  ownerUser       User       @relation(fields: [owner], references: [address])
  transfers       TokenTransfer[]

  @@index([owner, isBurned])
  @@index([level])
  @@map("tokens")
}

// Donation model - Transaction records
model Donation {
  id              Int        @id @default(autoincrement())
  projectId       Int
  donor           String
  amount          String     // BigInt as string (Wei)
  badgeLevel      Int        // Token level earned
  transactionHash String     @unique
  blockNumber     Int
  timestamp       DateTime   @default(now())

  project         Project    @relation(fields: [projectId], references: [id])
  donorUser       User       @relation(fields: [donor], references: [address])

  @@index([projectId])
  @@index([donor])
  @@index([timestamp])
  @@map("donations")
}

// TokenTransfer model - Transfer history
model TokenTransfer {
  id              Int        @id @default(autoincrement())
  tokenId         Int
  from            String
  to              String
  transactionHash String
  timestamp       DateTime   @default(now())

  token           Token      @relation(fields: [tokenId], references: [tokenId])

  @@index([tokenId])
  @@index([from])
  @@index([to])
  @@map("token_transfers")
}

// TokenConversion model - Conversion events
model TokenConversion {
  id              Int        @id @default(autoincrement())
  owner           String
  burnedTokenIds  Int[]
  newTokenId      Int
  fromLevel       Int
  toLevel         Int
  transactionHash String
  timestamp       DateTime   @default(now())

  @@index([owner])
  @@index([timestamp])
  @@map("token_conversions")
}

// Stats model - Global statistics cache
model Stats {
  id              Int        @id @default(autoincrement())
  totalProjects   Int        @default(0)
  totalDonations  String     @default("0") // Total in Wei
  totalDonors     Int        @default(0)
  totalTokens     Int        @default(0)
  updatedAt       DateTime   @updatedAt

  @@map("stats")
}
